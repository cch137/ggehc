var d1 = ['9780070109100', '9780073108742', '9780073191461', '9780073191645', '9780073254821', '9780073373805', '9780073373812', '9780073373843', '9780073373874', '9780073373881', '9780073376226', '9780073380544', '9780073383095', '9780073383149', '9780073383170', '9780073397924', '9780073397962', '9780073398167', '9780073398204', '9780073401331', '9780073402758', '9780073513881', '9780073523323', '9780073529301', '9780073529363', '9780073529547', '9780073529585', '9780073534985', '9780077418823', '9780077428501', '9780077428976', '9780077429683', '9780077654764', '9780077697747', '9780077862619', '9780078021046', '9780078021510', '9780078021541'];
var d2 = ['9780078021541', '9780078021558', '9780078027680', '9780078028168', '9780078028229', '9780078028984', '9780078135781', '9780080977478', '9780081005996', '9780124104099', '9780124172197', '9780128000564', '9780128008539', '9780128012420', '9780130880055', '9780131103627', '9780131395060', '9780131424623', '9780131437401', '9780131776913', '9780131871410', '9780131873742', '9780131877153', '9780131879690', '9780132126953', '9780132145183', '9780132157803', '9780132217354', '9780132297516', '9780132549868', '9780132871693', '9780133002287', '9780133072969', '9780133109047', '9780133116649', '9780133356038', '9780133356717', '9780133356816', '9780133411898', '9780133484175', '9780133489736', '9780133496598', '9780133496703', '9780133507690', '9780133514896', '9780133587937', '9780133592511', '9780133594140', '9780133741636', '9780133760064', '9780133778847', '9780133799521', '9780133826654', '9780133840544'];
var d3 = ['9780133840544', '9780133840803', '9780133898316', '9780133915389', '9780133918922', '9780133923605', '9780133935585', '9780133942651', '9780133943030', '9780133979121', '9780134015187', '9780134045443', '9780134060491', '9780134074252', '9780134083308', '9780134092669', '9780134098845', '9780134101613', '9780134112527', '9780134115764', '9780134129969', '9780134133539', '9780134138046', '9780134149530'];
var d4 = ['9780134149530', '9780134156323', '9780134181981', '9780134204925', '9780134237473', '9780134243924', '9780134306414', '9780134310053', '9780134319650', '9780134320533', '9780134325088', '9780134361307', '9780134382593', '9780134407623', '9780134414232', '9780134437705', '9780134438986', '9780134441184', '9780134444321', '9780134462028', '9780134462455', '9780134466040', '9780134469164', '9780134472140'];
var d5 = ['9780134472140', '9780134474021', '9780134497181', '9780134508306', '9780134549897', '9780134589640', '9780134610672', '9780134670959', '9780134683713', '9780135072950', '9780135073094', '9780135184738', '9780136019251', '9780136139263', '9780136156734', '9780138147570', '9780190264482', '9780190698669', '9780195158335', '9780195331455', '9780198769866', '9780199339136', '9780201128192', '9780201308570', '9780201748826', '9780201847659', '9780205258154', '9780205989751', '9780262258104', '9780321441461', '9780321625922', '9780321629111', '9780321691699', '9780321729569'];
var d6 = ['9780321729569', '9780321780652', '9780321796974', '9780321796981', '9780321797056', '9780321797094', '9780321817624', '9780321851666', '9780321856562', '9780321870025', '9780321879721', '9780321909107', '9780321924490', '9780321931900', '9780321937711', '9780321947048', '9780321950970'];
var d7 = ['9780321950970', '9780321955050', '9780321962218', '9780321964687', '9780321973610', '9780321976444', '9780321977069', '9780321978981', '9780321979391', '9780321982384', '9780321989437', '9780321989581', '9780321993724', '9780323429429', '9780387331959', '9780393925166', '9780393929720', '9780393936315', '9780470458310', '9780470458365'];
var d8 = ['9780470458365', '9780470501979', '9780470938454', '9780471098812', '9780471164746', '9780471198260', '9780471356059', '9780471433378', '9780471720645', '9780495110811', '9780495391326', '9780538733502', '9780789757463', '9780815344322', '9780935702750', '9780980232776', '9781107189638', '9781111543709', '9781111576714', '9781111837266', '9781118063330', '9781118078877', '9781118116135', '9781118131992', '9781118138915', '9781118140628', '9781118156322', '9781118170519', '9781118302798', '9781118324578', '9781118434413', '9781118477502', '9781118486894', '9781118539293', '9781118539712', '9781118743201', '9781118803042', '9781118832301', '9781118875056'];
var d9 = ['9781118875056', '9781118880685', '9781118885840', '9781118897843', '9781118912652', '9781118914496', '9781118914502', '9781118918401', '9781118919972', '9781118930113', '9781119034339', '9781119140313', '9781119142362', '9781119159599', '9781119306856', '9781133103752', '9781133104261', '9781133187790', '9781133281009', '9781133388081', '9781133608424', '9781133628477', '9781133939146', '9781133943891', '9781133951889', '9781259129919', '9781259191671', '9781259222139', '9781259277214', '9781259426162', '9781259536359', '9781259545474', '9781259582226', '9781259638091', '9781259660269', '9781259666360', '9781259676987', '9781259722660', '9781259877827', '9781259916823', '9781260008722'];
var d10 = ['9781260008722', '9781260159516', '9781260501186', '9781260501384', '9781284077254', '9781284105902', '9781284107029', '9781285096551', '9781285607191', '9781285740621', '9781285849041', '9781285866314', '9781285866345', '9781285867977', '9781285965901', '9781292076683', '9781305071742', '9781305071759', '9781305076761', '9781305079151', '9781305080485', '9781305081550', '9781305084766', '9781305084858'];
var d11 = ['9781305084858', '9781305086272', '9781305093836', '9781305115347', '9781305176638', '9781305251809', '9781305253667', '9781305266506', '9781305268920', '9781305446427', '9781305482210', '9781305505797', '9781305537606', '9781305580343', '9781305581982', '9781305585126', '9781305627482', '9781305628458', '9781305635135', '9781305635180', '9781305657960', '9781305658004', '9781305887466', '9781305947542', '9781305952300', '9781305958098', '9781305965720', '9781305965799', '9781305970939', '9781319057916', '9781337098120', '9781337102087', '9781337117562', '9781337271073'];
var d12 = ['9781337271073', '9781337275347', '9781337278461', '9781337282291', '9781337399425', '9781337406420', '9781337515566', '9781337516556', '9781337516563', '9781337517317', '9781337517508', '9781337558075', '9781337671286', '9781337671576', '9781337672306', '9781405114165', '9781429215084', '9781429215107', '9781429254335'];
var d13 = ['9781429254335', '9781429275033', '9781439044421', '9781439062128', '9781439080351', '9781449679569', '9781449694616', '9781455728466', '9781464124921', '9781464135385', '9781464190759', '9781498728850', '9781506389394', '9781577667391', '9781619602090', '9781626616837', '9781630182014', '9781630182021', '9781630182038', '9781848000698', '9781934891162', '9781934891223', '9781938168208', '9783319110806'];
var d14 = ['9780023606922', '9780030839931', '9780071289474', '9780072291353', '9780072432022', '9780072467505', '9780073106991', '9780073316512', '9780073373775', '9780073373867', '9780073375779', '9780073376189', '9780073376356', '9780073380490', '9780073398006', '9780073398068', '9780073398273', '9780073404547', '9780073520575', '9780073523408', '9780073525365', '9780073529608', '9780077238292', '9780077417215', '9780077417956', '9780077418854', '9780077641214', '9780077733735', '9780077861018', '9780077861681', '9780077861704', '9780077861759', '9780077862510', '9780077862626', '9780078020551', '9780078023163', '9780078024269', '9780078034633', '9780078036071', '9780124166547', '9780128119068', '9780130144003', '9780130602435', '9780130612106', '9780130829870', '9780130882394', '9780131206687', '9780131415218', '9780131453401', '9780131456792', '9780131457898', '9780131471221', '9780131499331', '9780131679955']
var d15 = ['9780131679955', '9780131721517', '9780131755635', '9780131866140', '9780131873216', '9780132251136', '9780132492645', '9780132543033', '9780132544948', '9780132551557', '9780132558921', '9780132622882', '9780132744287', '9780132773706', '9780132783965', '9780132916523', '9780132943260', '9780132993340', '9780133001365', '9780133128741', '9780133250121', '9780133457476', '9780133499612', '9780133506471', '9780133507133', '9780133515008', '9780133544015', '9780133574845', '9780133594812', '9780133758887', '9780133760637', '9780133769401', '9780133773927', '9780133798074', '9780133886832', '9780133943023', '9780133970777', '9780133970784', '9780133985078', '9780134080215', '9780134085043', '9780134087702', '9780134111315', '9780134159386', '9780134167848', '9780134195421']
var d16 = ['9780134195421', '9780134217437', '9780134220130', '9780134307015', '9780134309040', '9780134322766', '9780134379760', '9780134437774', '9780134444284', '9780134446622', '9780134469119', '9780134484143', '9780134496436', '9780134543161', '9780134543536', '9780134566719', '9780134601656', '9780134608228', '9780134638942', '9780134689487', '9780134712826', '9780134718538']
var d17 = ['9780134718538', '9780134729572', '9780134734804', '9780134746241', '9780134802749', '9780135000045', '9780135000953', '9780135132159', '9780135136904', '9780135151037', '9780136006138', '9780136020400', '9780136042594', '9780136061250', '9780136061694', '9780136154167', '9780136510680', '9780137079209', '9780137134731', '9780138015626', '9780190200176', '9780190296902', '9780195384086', '9780201308600', '9780201543933', '9780201612530', '9780201726343', '9780201763904', '9780205820375', '9780321288356', '9780321305152', '9780321448040', '9780321500465', '9780321625922', '9780321693129', '9780321725554']
var d18 = ['9780321725554', '9780321747471', '9780321783677', '9780321794772', '9780321795434', '9780321807090', '9780321816191', '9780321816252', '9780321818508', '9780321825278', '9780321878052', '9780321923271', '9780321924599', '9780321929150', '9780321931078', '9780321946119', '9780321948908', '9780321964670', '9780321969354', '9780321977106', '9780321978264']
var d19 = ['9780321978264', '9780321979407', '9780321979476', '9780321986245', '9780321986498', '9780321987297', '9780321992789', '9780321997173', '9780321999580', '9780323064996', '9780323187114', '9780324599107', '9780387979748', '9780387988276', '9780393614077', '9780393918380', '9780393937503', '9780393979503', '9780395889022']
var d20 = ['9780395889022', '9780470048962', '9780470125397', '9780470383278', '9780470460641', '9780470631478', '9780470648056', '9780470936993', '9780471137726', '9780471143260', '9780471226932', '9780471415268', '9780471873730', '9780486474175', '9780495808916', '9780534359645', '9780534369576', '9780534380588', '9780534408961', '9780534420574', '9780534494834', '9780534494926', '9780534948542', '9780538452199', '9780538493635', '9780558813741', '9780803635753', '9780805385656', '9780813349107', '9780840068521', '9780989472104', '9781107014022', '9781111128531', '9781111527273', '9781111541354', '9781111569624', '9781111576004', '9781111577421']
var d21 = ['9781111577421', '9781111793715', '9781118012895', '9781118074817', '9781118146811', '9781118156599', '9781118210116', '9781118231463', '9781118457443', '9781118583197', '9781118771334', '9781118803301', '9781118881279', '9781119127666', '9781119148326', '9781119192138', '9781119227489', '9781119233404', '9781119299585', '9781119320937', '9781119368847', '9781119492962', '9781133006909', '9781133111368', '9781133112280', '9781133168577', '9781133281450', '9781133612315', '9781133626169', '9781133627777', '9781133691808']
var d22 = ['9781133691808', '9781133693383', '9781133710844', '9781133712350', '9781133727941', '9781133943914', '9781133945192', '9781133947257', '9781133947752', '9781259540554', '9781259550386', '9781259563652', '9781259680199', '9781259723223', '9781259765445', '9781259878091', '9781259915673', '9781259915727', '9781259929434', '9781259982736', '9781260501834', '9781260502497', '9781260502619', '9781260502893', '9781284055924', '9781284056259', '9781284070408', '9781284100952', '9781284123036', '9781285050904', '9781285186856', '9781285194059', '9781285225500', '9781285402062', '9781285444581', '9781285452340', '9781285454610', '9781285463247']
var d23 = ['9781285463247', '9781285528892', '9781285738567', '9781285842912', '9781285852706', '9781285856872', '9781285856919', '9781285947877', '9781285965949', '9781285974286', '9781292061320', '9781305071360', '9781305075771', '9781305079137', '9781305079250', '9781305080195', '9781305085312', '9781305104174', '9781305107649', '9781305107908', '9781305116634', '9781305156241', '9781305177741', '9781305251472', '9781305445932', '9781305480841', '9781305494602', '9781305494695', '9781305504912', '9781305578296', '9781305635111']
var d24 = ['9781305635111', '9781305652958', '9781305652972', '9781305656314', '9781305659728', '9781305734807', '9781305951495', '9781305959422', '9781305971493', '9781305971509', '9781323056301', '9781337101837', '9781337102070', '9781337272094', '9781337288781', '9781337399128', '9781337468039', '9781337551663', '9781337552516', '9781337555180', '9781337568944', '9781337569330', '9781337670012', '9781337670425', '9781401884260', '9781412991346', '9781418073534', '9781429201247', '9781429249959', '9781435483743', '9781435488885', '9781464124730', '9781464140860', '9781464142000', '9781466504318', '9781496302847', '9781631263545', '9781891389221', '9781934891162']
var d25 = ['9780065017281', '9780071086806', '9780072524932', '9780072566086', '9780072837032', '9780073052335', '9780073373607', '9780073376042', '9780073397900', '9780073402697', '9780073511214', '9780073512143', '9780073513805', '9780073516776', '9780073523439', '9780073525204', '9780073529356', '9780073529578', '9780077632182', '9780077668013', '9780078210488', '9780123744937', '9780123814166', '9780123850591', '9780123948113', '9780124077263', '9780124079489', '9780128017333', '9780128122754', '9780130084514', '9780130489890', '9780130625601', '9780130909992', '9780131008465', '9780131457300', '9780131481930', '9780131863897', '9780131874398', '9780132108577', '9780132122306', '9780132148696', '9780132156615', '9780132379250', '9780132496346', '9780132847377', '9780132991292', '9780133023442', '9780133058789', '9780133178579', '9780133379488', '9780133439274', '9780133485080']
var d26 = ['9780133485080', '9780133486872', '9780133544770', '9780133545456', '9780133546231', '9780133795028', '9780133864717', '9780133884876', '9780133951929', '9780134009087', '9780134014890', '9780134019192', '9780134078816', '9780134114217', '9780134127620', '9780134167381', '9780134173054', '9780134182919', '9780134235455', '9780134313122', '9780134396026', '9780134400242', '9780134414447', '9780134459639', '9780134463216', '9780134463971', '9780134475561', '9780134477206', '9780134495347', '9780134498379']
var d27 = ['9780134498379', '9780134519531', '9780134524061', '9780134605173', '9780134608204', '9780134609034', '9780134626055', '9780134635194', '9780134675985', '9780134676005', '9780134686974', '9780134686998', '9780134746753', '9780134746968', '9780134792293', '9780134801407', '9780135048740', '9780136020585', '9780136079477', '9780136919827', '9780137062706', '9780137079209', '9780195136135', '9780195136661', '9780198749691', '9780199282012', '9780199926848', '9780273768562', '9780321133045', '9780321547743', '9780321569769', '9780321616678', '9780321625922']
var d28 = ['9780321625922', '9780321698605', '9780321732590', '9780321766199', '9780321804907', '9780321814630', '9780321849427', '9780321902788', '9780321911216', '9780321916600', '9780321920300', '9780321924711', '9780321925121', '9780321925831', '9780321936875']
var d29 = ['9780321936875', '9780321943170', '9780321955791', '9780321961624', '9780321969330', '9780321984623', '9780324786439', '9780357035283', '9780357158722', '9780393522716', '9780470245996', '9780470424704', '9780470501962', '9780470542811', '9780470596791', '9780470632284', '9780470770108', '9780471134473', '9780471163626', '9780471226185', '9780471391906', '9780471394426', '9780471433316', '9780471467557', '9780471744870', '9780495114765', '9780521675994', '9780521867566', '9780534465483', '9780538466523', '9780538735186', '9780763765668', '9780805304022', '9780815344667', '9780821847916', '9780840062253', '9780840064189']
var d30 = ['9780840064189', '9780916060084', '9780941413350', '9781107661455', '9781111780326', '9781111835484', '9781118214343', '9781118324561', '9781118548639', '9781118674369', '9781118799055', '9781118804926', '9781118873731', '9781118879108', '9781118956670', '9781118997772', '9781119032090', '9781119078722', '9781119128694', '9781119233756', '9781119305828', '9781133105060', '9781133187844', '9781133278238', '9781133494683', '9781133713371', '9781259144387', '9781259233616', '9781259294303', '9781259300165', '9781259300233', '9781259329050', '9781259539060', '9781259549465', '9781259616020', '9781259631757', '9781259686702', '9781259706615', '9781259732669', '9781259732782', '9781259911149']
var d31 = ['9781259911149', '9781259919787', '9781260113273', '9781260373561', '9781260501759', '9781260502510', '9781284050233', '9781284094350', '9781284105315', '9781284141092', '9781285165738', '9781285174303', '9781285189758', '9781285401607', '9781285425719', '9781285438252', '9781285663401', '9781285845500', '9781285860114', '9781285866307', '9781285963754', '9781305117204', '9781305176348', '9781305177192', '9781305257795', '9781305269477', '9781305270107', '9781305387102', '9781305502147', '9781305537682', '9781305632134', '9781305654174', '9781305734845', '9781319030483', '9781319216801', '9781337282659', '9781337399074']
var d32 = ['9781337399074', '9781337399937', '9781337515092', '9781337516198', '9781337516259', '9781337516853', '9781337553292', '9781337561914', '9781337671002', '9781401842505', '9781401862923', '9781429242288', '9781429299060', '9781435438675', '9781439875902', '9781461403906', '9781464126116', '9781478623069', '9781478630913', '9781483378732', '9781558607354', '9781605352763', '9781618531650', '9781631263903', '9781886529236', '9781936221349', '9978013707920']

const d = [d1, d2, d3, d4, d5, d6, d7, d8, d9, d10, d11, d12, d13, d14, d15, d16, d17, d18, d19, d20, d21, d22, d23, d24, d25, d26, d27, d28, d29, d30, d31, d32];

import wixData from 'wix-data';
import wixLocation from 'wix-location';
import wixStorage from 'wix-storage';
import { absoluteLink } from 'backend/backend';
import { ouo } from 'backend/adf';
import { fetch } from 'wix-fetch';
import { linkvertise, linkvertise2 } from 'backend/linkvertise';

async function removeOldRecordFromDB(userID) {
    const query = wixData.query("userClicks").eq("userID", userID);
    const results = await query.find();
    if (results.items.length > 0) {
        const itemIdToDelete = results.items[0]._id;
        await wixData.remove("userClicks", itemIdToDelete);
    }
}

async function getArticleByISBN(isbnInput) {
    try {
        const result = await wixData.query('Articles').eq('isbn', isbnInput).limit(1).find();
        return result.items[0]?.article || null;
    } catch (error) {
        console.log(error);
        return null;
    }
}

$w.onReady(async () => {
    const article = await getArticleByISBN(wixLocation.path[0]);
    if (article) $w('#text21').text = article;

    const idx = d.findIndex(e => e.includes(wixLocation.path[0]));
    if (idx !== -1) {
        const q = (c, f) => wixData.query(c).contains(f[0], f[1]).ascending("timeStamp").limit(1000).find();
        const chapterResults = await q("Chapters", ["isbn", wixLocation.path[0]]);
        $w("#dropdown1").options = [...new Set(chapterResults.items.map(i => i.chapter))].map(c => ({ label: c, value: c }));
        
        $w("#dropdown1").onChange(async () => {
            const problemResults = await q("dsd" + (idx + 1), ["isbn_c_p", wixLocation.path[0] + "_" + $w("#dropdown1").value]);
            $w("#dropdown2").options = [...new Set(problemResults.items.map(i => i.problem))].map(c => ({ label: c, value: c }));
            $w("#dropdown2").enable();
        });

        $w("#button1").onClick(async () => {
            $w("#button2").label = "Generating Link";
            const interval = setInterval(() => {
                $w("#button2").label = "Generating Link" + ".".repeat($w("#button2").label.length - 15);
            }, 500);

            setTimeout(async () => {
                clearInterval(interval);
                const clickCount = parseInt(wixStorage.local.getItem("button2Clicks"), 10) || 0;
                const shouldShortenWithLinkvertise = clickCount > 6;
                const fileResults = await wixData.query("dsd" + (idx + 1))
                    .contains("fileName", `${wixLocation.path[0]}, Chapter ${$w("#dropdown1").value}, Problem ${$w("#dropdown2").value}.png`)
                    .find();

                let shortenFunc;
                if (shouldShortenWithLinkvertise) {
                    shortenFunc = clickCount % 2 === 0 ? linkvertise : linkvertise2;
                } else {
                    shortenFunc = ouo;
                }

                try {
                    const res = await shortenFunc(fileResults.items[0].link);
                    $w("#button2").link = res;
                    $w("#button2").label = res;
                } catch (error) {
                    console.log(error);
                }
            }, 3000);
        });
    }

    $w("#button2").onClick(async () => {
        let userID = wixStorage.local.getItem("userID");
        let clickCount = parseInt(wixStorage.local.getItem("button2Clicks"), 10) || 0;

        if (!userID) {
            userID = "usr_" + Math.random().toString(36).substr(2, 9);
            wixStorage.local.setItem("userID", userID);
            clickCount = 0;
        }

        clickCount += 1;
        wixStorage.local.setItem("button2Clicks", clickCount.toString());
        await removeOldRecordFromDB(userID);
        await wixData.insert("userClicks", { userID, clickCount });

        console.log(`User Key: ${userID}, Click Count: ${clickCount}`);
    });
});